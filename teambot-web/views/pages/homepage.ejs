<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RFID Tracking System</title>
  <link rel="stylesheet" href="/styles/custom.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>RFID Tracking System</h1>
      <p>Real-time RFID monitoring and status tracking</p>
    </header>

    <div class="table-container">
      <table id="rfid-table">
        <thead>
          <tr>
            <th>#</th>
            <th>RFID</th>
            <th>Status</th>
            <th>Date & Time</th>
          </tr>
        </thead>
        <tbody id="rfid-data">
          <!-- Data will be populated here from database -->
          <tr>
            <td colspan="4" class="empty-state">
              <h3>No Data Available</h3>
              <p>RFID tracking data will appear here once the database is connected.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Trying to fetch RFID data from the backend API
    // Using async/await because fetch returns a promise
    async function loadRFIDData() {
      try {
        // Making a GET request to our API endpoint
        const response = await fetch('/api/rfid-logs');
        const result = await response.json();
        
        // Check if we got data successfully
        if (result.success && result.data) {
          displayRFIDData(result.data);
        } else {
          console.error('Failed to load RFID data');
        }
      } catch (error) {
        // If something goes wrong (like server is down), show error message
        console.error('Error loading RFID data:', error);
        const tbody = document.getElementById('rfid-data');
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <h3>Error Loading Data</h3>
              <p>Failed to connect to the database. Please check your connection.</p>
            </td>
          </tr>
        `;
      }
    }

    // This function takes the data and puts it in the HTML table
    function displayRFIDData(data) {
      const tbody = document.getElementById('rfid-data');
      
      // If there's no data, show a message
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <h3>No Data Available</h3>
              <p>No RFID records found in the database.</p>
            </td>
          </tr>
        `;
        return;
      }

      // Loop through each record and create table rows
      tbody.innerHTML = data.map((item, index) => {
        // Figure out the color based on status
        // If rfid_status is true (1), use green. If false (0), use red
        const statusClass = item.rfid_status ? 'status-found' : 'status-not-found';
        const statusText = item.rfid_status ? '1' : '0';
        
        // Converting the datetime to GMT+8 with AM/PM format
        // Had to look up how to do timezone conversion in JavaScript
        const date = new Date(item.time_log);
        
        // Getting the date part first (MM/DD/YYYY)
        const dateStr = date.toLocaleDateString('en-US', {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        
        // Then the time part with AM/PM
        // Setting hour12 to true to get AM/PM instead of 24-hour format
        const timeStr = date.toLocaleTimeString('en-US', {
          timeZone: 'Asia/Taipei',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
        });
        
        // Combining date and time
        const datetime = `${dateStr}, ${timeStr}`;

        // Creating the HTML for each row
        return `
          <tr>
            <td>${index + 1}.</td>
            <td class="rfid-cell">${item.rfid_data}</td>
            <td class="${statusClass}">${statusText}</td>
            <td class="datetime-cell">${datetime}</td>
          </tr>
        `;
      }).join('');
    }

    // Run this when the page finishes loading
    document.addEventListener('DOMContentLoaded', () => {
      loadRFIDData();
      
      // Refresh the data every 5 seconds to show real-time updates
      // Using setInterval to call loadRFIDData repeatedly
      setInterval(loadRFIDData, 5000);
    });
  </script>
</body>
</html>
