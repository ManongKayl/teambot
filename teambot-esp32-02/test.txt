#include <Arduino.h>
#include <WiFi.h>
#include <PubSubClient.h>

// Define relay IN pin
#define RELAY_PIN 27

// Function declaration
void reconnectMQTT();
void callback(char* topic, byte* payload, unsigned int length);

// WiFi credentials
const char* ssid = "Cloud Control Network";
const char* password = "ccv7network";

// MQTT broker details
const char* mqttServer = "192.168.1.7";
const int mqttPort = 1883;
const char* mqttTopic = "RFID_LOGIN";

// MQTT client
WiFiClient espClient;
PubSubClient client(espClient);

// MQTT status tracking
bool mqttConnected = false;

// LED state tracking
bool ledState = false;

// Callback: handle incoming MQTT messages
void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("\nMessage arrived [");
  Serial.print(topic);
  Serial.print("]: ");

  // Build incoming message string
  String message = "";
  for (int i = 0; i < length; i++) {
    Serial.print((char)payload[i]);
    message += (char)payload[i];
  }
  Serial.println();

  // Remove surrounding whitespace and hidden characters
  message.trim();
  Serial.print("Parsed message: '");
  Serial.print(message);
  Serial.println("'");

  // Relay control logic
  if (message == "1") {
    ledState = true;
    digitalWrite(RELAY_PIN, HIGH);
    Serial.println("✅ Relay ON - LED ON");
  } else if (message == "0") {
    ledState = false;
    digitalWrite(RELAY_PIN, LOW);
    Serial.println("✅ Relay OFF - LED OFF");
  } else {
    Serial.println("⚠️ Message not recognized. Only '1' (ON) or '0' (OFF) supported.");
  }
}

void setup() {
  Serial.begin(9600);
  while (!Serial);

  // Initialize relay pin
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW); // Start OFF

  // Test relay
  Serial.println("Testing relay...");
  digitalWrite(RELAY_PIN, HIGH); delay(500);
  digitalWrite(RELAY_PIN, LOW);  delay(500);
  Serial.println("Relay test complete");

  Serial.println("\n===============================");
  Serial.println("ESP32 MQTT Subscriber Starting...");
  Serial.println("===============================\n");

  // Scan for WiFi networks
  Serial.println("Scanning for WiFi networks...");
  int n = WiFi.scanNetworks();
  Serial.printf("Scan complete. Found %d networks:\n", n);
  bool networkFound = false;
  for (int i = 0; i < n; ++i) {
    Serial.printf("%d: %s (%d dBm)\n", i + 1, WiFi.SSID(i).c_str(), WiFi.RSSI(i));
    if (WiFi.SSID(i) == ssid) {
      networkFound = true;
      Serial.println("*** Target network found! ***");
    }
  }
  if (!networkFound) Serial.println("⚠️ WARNING: Target network not found in scan!");

  // Connect to WiFi
  Serial.printf("Connecting to WiFi: %s\n", ssid);
  WiFi.begin(ssid, password);
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(1000);
    Serial.print(".");
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n✅ WiFi Connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());

    // Setup MQTT
    client.setServer(mqttServer, mqttPort);
    client.setCallback(callback);
    reconnectMQTT();
  } else {
    Serial.println("\n❌ WiFi Connection Failed!");
    Serial.print("Status: "); Serial.println(WiFi.status());
  }

  Serial.println("\nReady to receive MQTT messages...\n");
}

void loop() {
  // Ensure WiFi connection
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi disconnected. Reconnecting...");
    WiFi.begin(ssid, password);
    delay(5000);
    return;
  }

  // Ensure MQTT connection
  if (!client.connected()) {
    if (mqttConnected) {
      Serial.println("MQTT connection lost!");
      mqttConnected = false;
    }
    reconnectMQTT();
  }
  client.loop();
}

void reconnectMQTT() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    if (client.connect("teambot-esp32-02")) {
      Serial.println("connected ✅");
      client.subscribe(mqttTopic);
      Serial.printf("Subscribed to topic: %s\n", mqttTopic);
      mqttConnected = true;
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" — retrying in 5 seconds");
      delay(5000);
    }
  }
}